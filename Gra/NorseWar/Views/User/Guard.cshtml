@{
    ViewBag.Title = "Guard";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@{
    var user = (NorseWar.Models.Account)Session["User"];
    var guard = NorseWar.Helper.Methods.CheckGuard(user);

    var time = DateTime.Now;
    var level = NorseWar.Helper.Methods.ShowUserLevel(user);
    var quest = NorseWar.Helper.Methods.CheckIfQuest(user);

}

<div id="guardInfo">
    <h2>Warta</h2>
    Psst, chcesz dorobić troszkę grosza? <br />Doskonale! <br />Potrzymaj mój miecz i stań przy bramie. Wrócę za kilka godzin ;)<br /><br />
</div>
@if (guard && !quest)
{
    <div id="guardElements" style="visibility: hidden;">
        <div>Twoja warta, nie masz farta :(</div><br />
        <div><span id="count"></span></div>
        <div id="rectcont">
            <div id="remainingtimevisualization"></div>
        </div>
        <br />
        <div><input type="button" value="Anuluj" class="button success" onclick="cancelGuard();" /></div>
        <script>
        var guardStart;
        var guardEnd;


        $.ajax({
            type: 'POST',
            url: '@Url.Action("GuardEndTime", "User")',
            data: '',
            success: function (data) {
                //alert(parseInt(data[0].start) + " " + data[0].now + " " + data[0].end);
                var guardStart = data[0].start;
                var guardEnd = data[0].end;
                var counter = data[0].now;
                $("#guardElements").css({ "visibility": "visible" });
                var max_counter = parseInt(guardEnd - guardStart);
                var rwidth = $("#remainingtimevisualization").width();
                setInterval(function () {

                    counter--;

                    if (counter >= 0) {

                        //span = $("#count");
                        $("#count").html(secondsTimeSpanToHMS(counter));
                    }
                    if (counter === 0) {
                        $("#count").html("Twoja warta dobiegła końca :)");
                        clearInterval(counter);
                        location.reload();
                    }

                    var minus = rwidth * ((max_counter - counter) / max_counter);
                    $("#remainingtimevisualization").css({ width: rwidth - minus });
                }, 1100);
            }
        });


        function secondsTimeSpanToHMS(s) {
            var h = Math.floor(s / 3600); //Get whole hours
            s -= h * 3600;
            var m = Math.floor(s / 60); //Get remaining minutes
            s -= m * 60;
            return h + ":" + (m < 10 ? '0' + m : m) + ":" + (s < 10 ? '0' + s : s); //zero padding on minutes and seconds
        }

        function cancelGuard() {
            $.ajax({
                type: 'POST',
                url: '@Url.Action("GuardCancels", "User")',
                data: '',
                success: function (data) {
                    location.reload();
                }
            });
        }
        </script>
    </div>
}
else if(!guard && !quest)
{
    <div>
        <div>
            <!-- tu jakieś pierdolone tło może być -->
        </div>
        <div id="guardElements">
            <div id="guardSlider">
                <input type="range" value="1" min="1" max="10" step="1" id="sliderguard"> <br />
                <input type="button" onclick="setGuard()" value="Start" class="success button" /> <br /><br />
                <div id="guardtime">
                    1 godzina
                </div>
                <div id="hajs">
                    <script>
                        $("#hajs").html(Math.floor((@level*parseInt($("#sliderguard").val())*4)-(@level-(parseInt($("#sliderguard").val()))/10))+"&nbsp;"+'<img src="/Content/shiny-coin2.png" height="15">');
                    </script>
                </div>
            </div>

            <script>

            $(document).on('input', '#sliderguard', function () {
                setGuardTime();
            });

            function setGuard() {
                //tu nic nie ma, lecz powstanie
                //alert($("#sliderguard").val());
                var hours = $("#sliderguard").val();
                $.ajax({
                    type: 'POST',
                    url: '@Url.Action("GuardStarts", "User")',
                    data: "id=" + hours,
                    success: function (data) {
                        //alert("chuj");
                        //wyjebanie elementów i start paska
                        $("#guardSlider").remove();
                        var counter = hours * 3600;
                        var max_counter = hours * 3600;
                        var bar = "<div>";
                        bar += "<div><span id='count'></span></div>";
                        bar += "<div id='rectcont'><div id='remainingtimevisualization'></div></div><br/>";
                        bar += "<div><input type='button' value='Anuluj' class='button success' onclick='cancelGuard();'/></div>";

                        bar += "</div>";
                        $("#guardElements").html(bar);
                        var rwidth = $("#remainingtimevisualization").width();
                        setInterval(function () {

                            counter--;

                            if (counter >= 0) {
                                span = $("#count");
                                span.html(secondsTimeSpanToHMS(counter));
                            }
                            if (counter === 0) {
                                span.html("Twojas warta się skończyła");
                                clearInterval(counter);
                                location.reload();
                            }
                            var minus = rwidth * ((max_counter - counter) / max_counter);
                            $("#remainingtimevisualization").css({ width: rwidth - minus });
                        }, 1100);

                    }
                });
            }

            function setGuardTime() {
                var value = parseInt($("#sliderguard").val());
                if (value === 1) {
                    $("#guardtime").html($("#sliderguard").val() + " godzina");
                } else if (value === 2 || value === 3 || value === 4) {
                    $("#guardtime").html($("#sliderguard").val() + " godziny");
                } else {
                    $("#guardtime").html($("#sliderguard").val() + " godzin");
                }
                $("#hajs").html(Math.floor((@level*parseInt($("#sliderguard").val())*4)-(@level-(parseInt($("#sliderguard").val()))/10))+"&nbsp;"+'<img src="/Content/shiny-coin2.png" height="15">');
                //(lvl * time * 4) - (lvl - (time / 10))
            }

            function secondsTimeSpanToHMS(s) {
                var h = Math.floor(s / 3600); //Get whole hours
                s -= h * 3600;
                var m = Math.floor(s / 60); //Get remaining minutes
                s -= m * 60;
                return h + ":" + (m < 10 ? '0' + m : m) + ":" + (s < 10 ? '0' + s : s); //zero padding on minutes and seconds
            }

            function cancelGuard() {
                $.ajax({
                    type: 'POST',
                    url: '@Url.Action("GuardCancels", "User")',
                    data: '',
                    success: function (data) {
                        location.reload();
                    }
                });
            }

            </script>
        </div>
    </div>
}
else if (!guard && quest)
{
    <div id="guardElements" style="visibility: hidden;">
        <div id="questInfo">Jesteś na zadaniu xD</div><br />
        <div id="questTimer"><span id="count"></span></div>
        <div id="rectcont">
            <div id="remainingtimevisualization"></div>
        </div>
        <br />
        <div><input type="button" value="Anuluj" class="button success" onclick="cancelTavern();" /></div>
        <script>
        $("#guardInfo").remove();
        var guardStart;
        var guardEnd;

        function cancelTavern() {
            $.ajax({
                type: 'POST',
                url: '@Url.Action("MissionCancels", "User")',
                data: '',
                success: function (data) {
                    location.reload();
                }
            });
        }

        $.ajax({
            type: 'POST',
            url: '@Url.Action("QuestEndTime", "User")',
            data: '',
            success: function (data) {
                //alert(parseInt(data[0].start) + " " + data[0].now + " " + data[0].end);
                var guardStart = data[0].start;
                var guardEnd = data[0].end;
                var counter = data[0].now;
                $("#guardElements").css({ "visibility": "visible" });
                var max_counter = parseInt(guardEnd - guardStart);
                var rwidth = $("#remainingtimevisualization").width();
                setInterval(function () {

                    if (counter < 0) {
                        $("#questInfo").remove();
                        $("#questTimer").remove();
                        $("#rectcont").remove();

                        $("#guardElements").html("<div id='questCompleted'>Udało ci się pokonać potworka xD</div>" +
                                                 "<div id='qButton'><input type='button' class='button success' value='OK' onclick='finishQuest();'/></div>");
                    }

                    counter--;

                    if (counter >= 0) {

                        //span = $("#count");
                        $("#count").html(secondsTimeSpanToHMS(counter));
                    }
                    if (counter === 0) {
                        $("#count").html("Twoje zadanie dobiegło końca :)");
                        clearInterval(counter);
                        location.reload();
                    }

                    var minus = rwidth * ((max_counter - counter) / max_counter);
                    $("#remainingtimevisualization").css({ width: rwidth - minus });
                }, 1100);
            }
        });


        function secondsTimeSpanToHMS(s) {
            var h = Math.floor(s / 3600); //Get whole hours
            s -= h * 3600;
            var m = Math.floor(s / 60); //Get remaining minutes
            s -= m * 60;
            return h + ":" + (m < 10 ? '0' + m : m) + ":" + (s < 10 ? '0' + s : s); //zero padding on minutes and seconds
        }

        function cancelGuard() {
            $.ajax({
                type: 'POST',
                url: '@Url.Action("GuardCancels", "User")',
                data: '',
                success: function (data) {
                    location.reload();
                }
            });
        }

        function finishQuest() {
            $.ajax({
                type: 'POST',
                url: '@Url.Action("FinishQuest", "User")',
                data: '',
                success: function (data) {
                    location.reload();
                }
            });
        }
        </script>
    </div>
}

<script>
    $(function () {
        $(".body-content").css({ "background-image": "url(../../Content/warta.png)", "background-size": "100%", "height": "515px" });
    });
</script>


